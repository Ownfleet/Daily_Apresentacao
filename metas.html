<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Metas ‚Ä¢ KPIs</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<style>
:root{
  --brand:#ee4d2d;--brand2:#ff6b3d;
  --bg:#0b0f19;--card:#111827;--ink:#f8fafc;
  --radius:18px;--shadow:0 12px 50px rgba(238,77,45,.3);
}
*{box-sizing:border-box;margin:0;padding:0;font-family:'Plus Jakarta Sans',system-ui,Arial}
body{
  background:var(--bg);color:var(--ink);
  display:flex;justify-content:center;align-items:center;
  min-height:100vh;overflow:hidden;
}
.card{
  background:linear-gradient(180deg,#141a25,#0e131f);
  padding:32px 28px;border-radius:var(--radius);
  box-shadow:var(--shadow);
  max-width:480px;width:95%;
}
h1{text-align:center;margin-bottom:22px;font-weight:900;color:var(--brand2);}
label{font-weight:600;display:block;margin-top:10px;color:#e5edf6;}
input,select,button{
  width:100%;padding:12px;margin-top:6px;
  border:none;border-radius:10px;font-size:15px;
}
input,select{
  background:#1a2233;color:#fff;border:1px solid #2b3549;transition:.2s;
}
input:focus,select:focus{
  outline:none;border:1px solid var(--brand2);
  box-shadow:0 0 8px rgba(255,107,61,.3);
}
button{
  background:var(--brand2);color:#fff;font-weight:800;margin-top:22px;
  cursor:pointer;transition:.3s;
}
button:hover{filter:brightness(1.1);transform:translateY(-2px);}
.msg{text-align:center;margin-top:14px;font-weight:700;color:#cfd8ea;}
.fab-container{
  position:fixed;bottom:28px;right:28px;
  display:flex;flex-direction:column;align-items:flex-end;
  gap:12px;z-index:30;
}
.fab{
  width:58px;height:58px;border-radius:50%;
  background:var(--brand2);
  color:#fff;font-size:22px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:.3s;
  box-shadow:0 6px 16px rgba(238,77,45,.35);
}
.fab:hover{
  transform:translateY(-3px) scale(1.05);
  filter:brightness(1.1);
}
.fab-label{
  background:#1a2233;color:#fff;padding:8px 14px;border-radius:10px;
  margin-right:10px;font-size:14px;opacity:0;transform:translateX(10px);
  transition:.25s;pointer-events:none;
}
.fab:hover + .fab-label, .fab-label:hover{
  opacity:1;transform:translateX(0);
}
</style>
</head>
<body>

<div class="card">
  <h1>Metas por Hub</h1>

  <label>Hub</label>
  <select id="hubSelect"></select>

  <label>Performance (%)</label>
  <input type="text" id="metaPerf" placeholder="Ex: 98.5">

  <label>SPR (Valor)</label>
  <input type="number" step="0.01" id="metaSpr" placeholder="Ex: 10.2">

  <label>Share Moto (%)</label>
  <input type="text" id="metaShare" placeholder="Ex: 18.2">

  <label>Volumoso (Qtd)</label>
  <input type="number" step="0.01" id="metaVol" placeholder="Ex: 3">

  <button id="saveMeta">Salvar Metas</button>
  <div id="msg" class="msg"></div>
</div>

<!-- üî∏ Bot√µes Flutuantes -->
<div class="fab-container">
  <div style="display:flex;align-items:center;">
    <div class="fab" onclick="window.location.href='index.html'">üìù</div>
    <div class="fab-label">Registrar KPIs</div>
  </div>
  <div style="display:flex;align-items:center;">
    <div class="fab" onclick="window.location.href='dashboard.html'">üìä</div>
    <div class="fab-label">Dashboard</div>
  </div>
</div>

<script>
const SUPABASE_URL="https://tflfageylbpvsvtjklsd.supabase.co";
const SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRmbGZhZ2V5bGJwdnN2dGprbHNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTU0MDcsImV4cCI6MjA3Nzg5MTQwN30.7qsg723aIgCFaOXTsG2gESeJ3MEMcvOhJjPFCV0mBiw";
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);

const hubSelect=document.getElementById('hubSelect');
const msg=document.getElementById('msg');
const saveBtn=document.getElementById('saveMeta');
const inputs=["metaPerf","metaSpr","metaShare","metaVol"].map(id=>document.getElementById(id));
let editing=false;
let currentHub=null;
let currentMetaId=null;

// permitir ponto nos campos %
function enforceDecimalPoint(id){
  const el=document.getElementById(id);
  el.addEventListener("input",()=>{
    el.value=el.value.replace(",","."); 
    el.value=el.value.replace(/[^0-9.]/g,"");
    const parts=el.value.split(".");
    if(parts.length>2){el.value=parts[0]+"."+parts.slice(1).join("");}
  });
  el.addEventListener("blur",()=>{
    if(el.value!==""){el.value=parseFloat(el.value).toFixed(2);}
  });
}
["metaPerf","metaShare"].forEach(enforceDecimalPoint);

async function loadHubs(){
  const {data,error}=await sb.from('hubs').select('*').order('name');
  if(error){msg.textContent="Erro ao carregar hubs.";return;}
  hubSelect.innerHTML=data.map(h=>`<option value="${h.id}">${h.name}</option>`).join('');
  if(data.length){hubSelect.value=data[0].id;loadMeta();}
}

hubSelect.onchange=()=>loadMeta();

async function loadMeta(){
  const hub_id=hubSelect.value;
  if(!hub_id)return;
  msg.textContent="‚è≥ Carregando metas...";
  const {data,error}=await sb.from('kpi_meta').select('*').eq('hub_id',hub_id).eq('active',true).maybeSingle();
  if(error){msg.textContent="Erro: "+error.message;return;}
  if(!data){
    msg.textContent="üì≠ Nenhuma meta cadastrada para este hub.";
    inputs.forEach(i=>{i.value="";i.disabled=false;});
    saveBtn.textContent="Salvar Metas";
    editing=false;currentMetaId=null;
    return;
  }

  // j√° existe meta salva
  document.getElementById('metaPerf').value=data.performance_meta;
  document.getElementById('metaSpr').value=data.spr_meta;
  document.getElementById('metaShare').value=data.share_moto_meta;
  document.getElementById('metaVol').value=data.volumoso_meta;
  currentMetaId=data.id;
  inputs.forEach(i=>i.disabled=true);
  saveBtn.textContent="Editar Metas";
  editing=false;
  msg.textContent="‚úÖ Metas carregadas e bloqueadas.";
}

saveBtn.onclick=async()=>{
  const hub_id=hubSelect.value;
  if(!hub_id){msg.textContent="‚ö†Ô∏è Selecione um hub.";return;}

  if(!editing && currentMetaId){
    // modo de edi√ß√£o
    inputs.forEach(i=>i.disabled=false);
    saveBtn.textContent="Salvar Edi√ß√£o";
    editing=true;
    msg.textContent="‚úèÔ∏è Edite os valores e salve.";
    return;
  }

  const row={
    hub_id,
    performance_meta:Number(document.getElementById('metaPerf').value),
    spr_meta:Number(document.getElementById('metaSpr').value),
    share_moto_meta:Number(document.getElementById('metaShare').value),
    volumoso_meta:Number(document.getElementById('metaVol').value),
    active:true
  };

  // desativar metas anteriores do hub
  await sb.from('kpi_meta').update({active:false}).eq('hub_id',hub_id).eq('active',true);

  if(currentMetaId && editing){
    // atualiza√ß√£o
    const {error}=await sb.from('kpi_meta').update(row).eq('id',currentMetaId);
    msg.textContent=error?"‚ùå Erro: "+error.message:"‚úÖ Edi√ß√£o salva com sucesso!";
  }else{
    // primeira inser√ß√£o
    const {error}=await sb.from('kpi_meta').insert(row);
    msg.textContent=error?"‚ùå Erro: "+error.message:"‚úÖ Meta cadastrada com sucesso!";
  }

  inputs.forEach(i=>i.disabled=true);
  saveBtn.textContent="Editar Metas";
  editing=false;
};

loadHubs();
</script>
</body>
</html>
